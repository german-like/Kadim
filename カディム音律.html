<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ラベル付き音律キーボード</title>
  <style>
    .keyboard {
      display: flex;
      position: relative;
      height: 200px;
      user-select: none;
    }
    .key {
      width: 30px;
      height: 100%;
      border: 1px solid #000;
      background: white;
      text-align: center;
      line-height: 180px;
      font-size: 12px;
      position: relative;
      z-index: 1;
    }
    .key.black {
      width: 20px;
      height: 120px;
      background: black;
      color: white;
      position: absolute;
      top: 0;
      z-index: 2;
    }
    .label {
      position: absolute;
      bottom: 4px;
      width: 100%;
      text-align: center;
      font-size: 10px;
    }
  </style>
</head>
<body>
  <div class="keyboard" id="keyboard"></div>

  <script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const f0 = 130.81;
    const stepRatio = Math.pow(3, 1/17);
    const labels = ["Da","Va","La","Ga","Ta","Pa","Na","Ma","Sa","Ra","Sha","Ka","Xa","Pha","Ja","Ba","Wa"];
    const blackKeyNs = [2,3,6,7,10,11,14,15];
    const activeNotes = {};

    const keyboardEl = document.getElementById("keyboard");

    for (let n = 0; n < 17; n++) {
      const freq = f0 * Math.pow(stepRatio, n);
      const isBlack = blackKeyNs.includes(n);
      const key = document.createElement("div");
      key.className = "key" + (isBlack ? " black" : "");
      key.style.left = `${n * 17}px`;
      key.dataset.n = n;
      key.dataset.freq = freq;
      key.dataset.label = labels[n % labels.length];
      key.innerHTML = `<div class="label">${labels[n % labels.length]}</div>`;
      
      key.addEventListener("mousedown", () => {
        startTone(freq, n);
      });
      key.addEventListener("mouseup", () => {
        stopTone(n);
      });
      key.addEventListener("mouseleave", () => {
        stopTone(n);
      });
      keyboardEl.appendChild(key);
    }

    document.addEventListener("mouseup", () => {
      Object.keys(activeNotes).forEach(n => stopTone(n));
    });

    function startTone(frequency, keyID) {
      if (activeNotes[keyID]) return;

      const osc = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      osc.type = "sine"; // 弦楽器風
      osc.frequency.setValueAtTime(frequency, audioCtx.currentTime);
      gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
      gainNode.gain.linearRampToValueAtTime(0.8, audioCtx.currentTime + 0.1); // フェードイン

      osc.connect(gainNode);
      gainNode.connect(audioCtx.destination);

      osc.start();

      activeNotes[keyID] = { osc, gainNode };
    }

    function stopTone(keyID) {
      const note = activeNotes[keyID];
      if (!note) return;

      const now = audioCtx.currentTime;
      note.gainNode.gain.cancelScheduledValues(now);
      note.gainNode.gain.setValueAtTime(note.gainNode.gain.value, now);
      note.gainNode.gain.linearRampToValueAtTime(0.0001, now + 0.3); // フェードアウト
      note.osc.stop(now + 0.3);

      delete activeNotes[keyID];
    }
  </script>
</body>
</html>
